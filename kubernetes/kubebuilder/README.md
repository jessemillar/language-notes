# Kubebuilder

> Notes taken while reading [this documentation](https://book.kubebuilder.io/introduction.html).

## Terminology

- CRD
	- Custom Resource Definition
- Group
	- A Group contains one or more Versions
- Version
	- A Version allows us to change how an API works over time
- Kind
	- An API type (each group-version contains one or more Kinds)
- Resources
	- A use of a Kind in the API
		- "For instance, the pods resource corresponds to the Pod Kind. However, sometimes, the same Kind may be returned by multiple resources. For instance, the Scale Kind is returned by all scale subresources, like deployments/scale or replicasets/scale."
	- Notice that resources are always lowercase, and by convention are the lowercase form of the Kind.

## General Notes

- When designing a k8s API, all serialized fields *must* be `camelCase`
	- Kubebuilder uses JSON struct tags to specify the casing
	- It seems to be convention to `omitempty` any JSON fields that could be empty
- "Fields may use most of the primitive types. Numbers are the exception: for API compatibility purposes, we accept three forms of numbers: `int32` and `int64` for integers, and `resource.Quantity` for decimals."
- "There's one other special type that we use: `metav1.Time`. This functions identically to `time.Time`, except that it has a fixed, portable serialization format."
- [Comments similar to `// +comment` are called markers](https://book.kubebuilder.io/reference/markers.html)
	- They're used by the `controller-tools` binary when generating CRD manifests
- "If you've taken a peek at the rest of the files in the `api/v1/` directory, you might have noticed two additional files beyond `cronjob_types.go`: `groupversion_info.go` and `zz_generated.deepcopy.go`. Neither of these files ever needs to be edited (the former stays the same and the latter is autogenerated)."
- "Controllers are the core of Kubernetes, and of any operator. It's a controller's job to ensure that, for any given object, the actual state of the world (both the cluster state, and potentially external state like running containers for Kubelet or load balancers for a cloud provider) matches the desired state in the object."
	- We call this process reconciling.
	- "Most controllers eventually end up running on the cluster, so they need RBAC permissions, which we specify using controller-tools RBAC markers. These are the bare minimum permissions needed to run. As we add more functionality, we'll need to revisit these."

		```
		// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete
		// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch
		```

	- "The context is used to allow cancellation of requests, and potentially things like tracing. It's the first argument to all client methods. The Background context is just a basic context without any extra data or timing restrictions."
- It seems like Kubebuilder automatically updates `main.go` in a number of circumstances
	- I wonder how often we actually manually modify `main.go`?
	- Do the automatic updates overwrite manual comments in `main.go`?

## Adding a New API

- Generate an API with a command similar to `kubebuilder create api --group batch --version v1 --kind CronJob`
	- This creates `api/v1/cronjob_types.go`
		- Inside this file, we define/modify a couple things:
			1. `Spec`
			1. `Status`
		- In general, we don't modify the `CronJob` or `CronJobList` structs inside this file -- all modifications go in either Spec or Status

## Webhooks

- "Admission webhooks are HTTP callbacks that receive admission requests, process them and return admission responses."
- It's best practice to wrap webhooks in an environment variable check so they can be disabled when running locally
	- "If you want to run the webhooks locally, you’ll have to generate certificates for serving the webhooks, and place them in the right directory (`/tmp/k8s-webhook-server/serving-certs/tls.{crt,key}`, by default)."
	- "If you’re not running a local API server, you’ll also need to figure out how to proxy traffic from the remote cluster to your local webhook server. For this reason, we generally recommended disabling webhooks when doing your local code-run-test cycle, as we do below."
- It's [recommended](https://book.kubebuilder.io/cronjob-tutorial/running-webhook.html) to use a [kind](https://book.kubebuilder.io/reference/kind.html) cluster when developing local webhooks
	- You may need to [deploy a cert manager](https://book.kubebuilder.io/cronjob-tutorial/cert-manager.html) to be fully functional

### Implementing Defaulting/Validating Webhooks

- "We use the `webhook.Defaulter` interface to set defaults to our CRD. A webhook will automatically be served that calls this defaulting. The `Default` method is expected to mutate the receiver, setting the defaults."
- "The `ValidateCreate`, `ValidateUpdate` and `ValidateDelete` methods are expected to validate that its receiver upon creation, update and deletion respectively."
